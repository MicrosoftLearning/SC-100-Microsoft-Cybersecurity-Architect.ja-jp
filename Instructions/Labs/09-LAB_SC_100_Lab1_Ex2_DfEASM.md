# 外部の攻撃対象領域の管理

## 演習の概要

Contoso は、外部攻撃面を特定して管理することで、サイバーセキュリティ態勢を強化することを目指しています。 この面には、様々なクラウド プロバイダーでホストされている資産が含まれています。 この目標を達成するために、Contoso は攻撃面データを、クラウドネイティブ SIEM ソリューションである Sentinel と統合したいと考えています。 この統合により、セキュリティ監視とインシデント対応機能が強化されます。 

## パート 1: ソリューションを設計する (必須)

このタスクでは、外部に公開されている資産とその攻撃面の概要を把握するための概念を設計します。

### 設計アプローチ

最初の手順では、説明されているシナリオに基づいて要件を分析し、目的を理解し、要件を定義します。

提供されているユース ケースに基づいて、次の要件を概説できます。

- Contoso の外部に公開されている資産は、監視およびセキュリティで保護する必要があります
- Contoso に関連付けられているすべての資産を検出します
- Contoso の SIEM ソリューションにデータを統合します。
- 資産は管理およびラベル付けする必要があります

2 番目の手順では、Contoso Ltd.の既存の環境を調べます。 Microsoft Defender 外部攻撃面管理 (EASM) は、組織のオンライン インフラストラクチャの外部への露出を示すために、デジタル攻撃面を継続的に検出してマップします。 公開されているリソースを特定し、リスクに優先順位を付け、ファイアウォールを越えて脆弱性と露出の制御を拡張します。

### 提案されるソリューション

|要件|解決策|行動計画|
|----|----|----|
|Contoso の外部に公開されている資産は、監視およびセキュリティで保護する必要があります| Defender EASM | Microsoft Defender EASM リソースの作成|
|Contoso に関連付けられているすべての資産を検出します | Defender EASM |Contoso の資産で検出ジョブを作成する  |
|Contoso の SIEM ソリューションにデータを統合します |Defender EASM、Log Analytics ワークスペース | Log Analytics ワークスペースを Defender EASM に接続します |
|資産は管理およびラベル付けする必要があります | Defender EASM | 課金対象資産とタグを管理します |


## パート 2: ソリューションを実施する (オプション)

### タスク 1 - Defender EASM をセットアップする

このタスクでは、Defender EASM ワークスペースを作成します。

1. Client 1 VM (LON-Sc1) に **lon-cl1\admin** アカウントでログインします。 パスワードは、ラボ ホスティング プロバイダーから支給されます。
1. **Microsoft Edge** を開いて、アドレス バーを選択し、**`https://portal.azure.com`** に移動して、Azure portal にユーザー <user1-ZZZZZZZ@LODSUATMCA.onmicrosoft.com> としてログインします。 管理者のパスワードは、ラボ ホスティング プロバイダーから支給されます。
1. [サインインの状態を維持しますか?] ダイアログボックスで、[今後このメッセージを表示しない] チェックボックスを選択し、[いいえ] を選択します。
1. **[いいえ]** を選択して下部で表示されるパスワード保存のダイアログを閉じ、ご利用のブラウザー内で既存のグローバル管理者の認証情報が保存されないようにします。
1. 上部の検索バーで、**`Microsoft Defender EASM`** を検索します。
1. **［作成］** を選択します
1. [Microsoft Defender EASM リソースの作成] で、既存のリソース グループ **rg_eastus_soc** を選択します。
    >[!NOTE] rg_eastus_soc リソース グループが一覧にない場合は、新しいラボ インスタンスを開いても以前の作業は保持されないため、もう一度作成する必要があります。
1. [インスタンスの詳細] に名前 **`EASM`** を入力し、リージョンに **[米国東部]** を選択します。
1. **[確認と作成]** を選択します。
1. **［作成］** を選択します

Defender EASM ワークスペースが正常に作成されました。

### タスク 2 - 検出を作成する

このタスクでは、Contoso Ltd. の外部に公開されている資産に検出を作成します。 インスタンスを作成したら、実際のデータを設定する必要があります。 そのため、ここで検出を作成します。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. 上部の検索バーで、**`Microsoft Defender EASM`** を検索して開きます。
1. 最後のタスクで作成した **EASM** ワークスペースを選択します。
1. **[組織を検索]** 検索フィールドで **Contoso** を検索します。
1. **[Contoso Ltd.]** を選択します。
1. **[攻撃面検出の開始]** を選択します。

Contoso の外部攻撃面の検出を正常に作成し、アクション可能なデータを EASM インスタンスに設定しました。

### タスク 3 - データ コネクタと Log Analytics ワークスペースをセットアップする

このタスクでは、Defender EASM から Sentinel に使用される Log Analytics ワークスペースへのデータ接続を構成します。 Defender EASM の資産または分析情報を Log Analytics で使用することで、既存のワークフローを他のセキュリティ データで強化できます。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. 上部の検索バーで **`Log Analytics Workspaces`** を検索します。
1. 前回の演習から **law-sentinel** ワークスペースを選択します。
    >[!NOTE] law-sentinel ワークスペースが一覧にない場合は、新しいラボ インスタンスを開いても以前の作業は保持されないため、もう一度作成する必要があります。 演習「セキュリティ オペレーション センター」のパート 2 タスク 1 を参照してください。
1. ページはそのままにして別のタブを開き、Azure portal **`https://portal.azure.com`** にログインします。
1. 上部の検索バーで、**`Microsoft Defender EASM`** を検索して開きます。
1. **EASM** ワークスペースを選択します。
1. 左側のナビゲーション ウィンドウで、**[管理]** を展開し、**[データ接続]** を選択します。
1. [Log Analytics] で、**[接続の追加]** を選択します。
1. 「**law-sentinel**」という名前を付けます。
1. 開いている Log Analytics ワークスペースを使用して、前のタブに切り替えます。
1. **[Log Analytics エージェントの手順]** を展開します。
1. **ワークスペース ID** を [データ接続の追加] ウィンドウの対応するフィールドにコピーします。
1. ****主キー**を [データ接続の追加] ウィンドウの "API キー" フィールドにコピーします。
1. [コンテンツ] で **[すべて]** を選択します。
1. [頻度] で **[毎日]** を選択します。
1. **[追加]** を選択します。
1. [データ接続] ページの Log Analytics カードで、"Connected (1)" の下に law-sentinel が表示されるはずです。

接続が作成されると、カスタム ログ テーブルが Log Analytics ワークスペースに作成されます。 Sentinel では、このデータを使用して、セキュリティ インシデントの作成またはエンリッチ、調査プレイブックの構築、機械学習アルゴリズムのトレーニング、修復アクションのトリガーを行うことができます。

Defender EASM と Log Analytics ワークスペースとの間の接続が正常に設定されました。

### タスク 4 - ダッシュボードを確認し、資産にラベルを付ける

このタスクでは、Defender EASM セキュリティ態勢を確認し、結果に関する情報を取得します。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. 上部の検索バーで、**`Microsoft Defender EASM`** を検索して開きます。
1. **EASM** ワークスペースを選択します。
1. 左側のナビゲーション ウィンドウで、**[ダッシュボード]** を展開し、**[攻撃面の概要]** を選択します。 [攻撃面の概要] ダッシュボードは、攻撃面の影響を受けた中核的な資産の主要な分析情報と概要を提供します。
1. **[攻撃面の概要]** ダッシュボードを確認します。
1. 左側のナビゲーション ウィンドウで、**[セキュリティ態勢]** を選択します。
1. 未解決の脆弱性について、様々なカテゴリを確認します。
1. カテゴリの **[ポートを開く]** で、**[Web サーバー]** を選択します。
1. 見つかった IP アドレス **34.223.124.45** を選択します。
1. 詳細な調査のために資産にラベルを付けます。
1. **[資産の変更]** を選択します。
1. **[新しいラベルの作成]** を選択します。
1. 「**ポートを開く**」という名前を付け、**[追加]** を選択します。
1. **[ラベル]** フィールドに新しく作成したラベルを割り当てます。
1. **[更新]** を選択します。

セキュリティ態勢を正常に確認し、さらに調査するために資産にラベルを付けました。

### タスク 5 - 資産を管理する

このタスクでは、検出された資産を管理および分類します。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. 上部の検索バーで、**`Microsoft Defender EASM`** を検索して開きます。
1. **EASM** ワークスペースを選択します。
1. 左側のナビゲーション ウィンドウで **[全般]** を展開し、**[インベントリ]** を選択します。
1. EASM | インベントリ ページで、[検索] タブが選択されています (下線付き)。 検索フィールドで、ドロップダウン メニューを使用して **[ラベル]** を選択します
1. 下のドロップダウン メニューで、最近作成したラベルである **[ポートを開く]** を選択します。
1. **[Search]** を選択します。
1. 見つかった資産 **34.223.124.45** を開きます。
1. **[Web コンポーネント]** タブを選択します。
1. この資産が Amazon でホストされていることを確認します。一部のコンポーネントには未解決の CVE もありますが、**[最新]** と **[最終表示]** 列に示されているように、これらはアクティブではありません。 これらは、以前の検出実行から作成されています。
この資産はサード パーティによってホストされていますが、攻撃対象領域に属しているため、組織での役割に基づいて分類します。
1. **[資産の変更]** を選択します。
1. [資産の変更] ウィンドウで、**[状態]** フィールドのドロップダウンを使用して **[依存関係]** を選択します。
1. **[更新]** を選択します。
    >[!NOTE]このケースでは、資産がサード パーティによって所有されていますが、ユーザーの攻撃対象領域の一部であるインフラストラクチャであるため、[依存関係] を選択します。これは、サード パーティがあなたの所有している資産の運用を直接サポートするからです。
1. 右上の **[X]** を選択してインベントリに戻り、新しい検索を作成します。
1. 検索クエリを **Web コンポーネント名 - contains - Amazon** に変更します。
1. **[Search]** を選択します。
1. すべての資産を選択します。
1. **[資産の変更]** を選択します。
1. [状態] で **[依存関係]** を選択し、**[更新]** を選択します。

[状態] が **[承認済みインベントリ]** に設定されている場合にのみ、資産はダッシュボード グラフで表され、毎日スキャンされます。 そのため、新しく検出された資産を確認し、それに応じて状態を変更することが重要です。

この演習の一環として、Defender EASM を設定し、Contoso の外部環境の検出を作成しました。資産とその構成に関する詳細な分析情報が得て、資産を管理したため、ダッシュボードには Contoso が直接責任を持つデータのみが含まれます。
