# セキュアなインフラ

Contoso Ltd. は最近 Tailwind Traders を買収しました。Tailwind Traders は、ストレージにローカル ファイル サーバーを引き続き使用しています。 Contoso Ltd. のサイバーセキュリティ アーキテクトとして、既存のクラウド環境でこれらのファイル サーバーをセキュリティで保護するソリューションを評価したいと考えています。 Tailwind Traders は、POC の実装に使用できるテスト サーバー (The Lab VM 2) を提供しました。 この演習では、サーバーを設定し、Azure Arc を使用してクラウド インフラストラクチャとセキュリティ環境に統合し、サーバー ログを Defender for Cloud に送信します。

## パート 1: ソリューションを設計する (必須)

このタスクでは、クラウド インフラストラクチャ内のオンプレミス環境をセキュリティで保護する概念を設計します。

### 設計アプローチ

最初の手順では、説明されているシナリオに基づいて要件を分析し、目的を理解し、要件を定義します。

提供されているユース ケースに基づいて、次の要件を概説できます。

- サブスクリプションで Defender for Cloud を有効にする
- オンプレミス サーバーをセキュリティで保護する必要がある
- Contoso の SIEM ソリューションでログを処理できるように、ログを保存する必要がある
- デプロイ リソースのコンプライアンス状態を評価する

2 番目の手順では、Contoso Ltd. の既存の環境を調べます。 Defender for Cloud では、構成とデプロイを改善するための手順を特定することで、クラウドとオンプレミスのリソースをセキュリティで保護するための推奨事項が提供されます。 ワークロードを積極的に監視することで、全体的なセキュリティ態勢が強化され、脅威にさらされるリスクが軽減されます。

### 提案されるソリューション

|要件|解決策|行動計画|
|----|----|----|
|サブスクリプションで Defender for Cloud を有効にする| Defender for Cloud | Defender for Cloud で Defender プランをアクティブ化する |
|オンプレミス サーバーをセキュリティで保護する必要がある | Azure Arc | オンプレミス サーバーをクラウド環境にオンボードする |
|Contoso の SIEM ソリューションで処理できるログを保存する必要がある |Defender for Cloud、DataCollectionRules、AzureMonitoring エージェント、Log Analytics ワークスペース | Contoso のオンプレミス サーバーからログを収集するデータ収集規則を作成する |
|デプロイ リソースのコンプライアンス状態を評価する | Defender for Cloud セキュリティ ポリシー| NIST SP 800-53 Rev.5 コンプライアンスを有効にし、コンプライアンスの状態を評価します。|

## パート 2: ソリューションを実施する (オプション)

### タスク 1: Log Analytics ワークスペースを作成する

このタスクでは、さまざまなリソースから送信されるデータを格納するために必要な Log Analytics ワークスペースを作成します。

1. Client 1 VM (LON-CL1) に **lon-cl1\admin** アカウントでログインします。 パスワードは、ラボ ホスティング プロバイダーから支給されます。
1. **Microsoft Edge** を開き、アドレス バーを選択し、**`https://portal.azure.com`** に移動し、ユーザー **User1-*******@LODSUATMCA.onmicrosoft.com** として Azure portal にログインします (****** はラボ ホスティング プロバイダーによって提供された固有のテナント ID)。 ユーザーのパスワードは、ラボ ホスティング プロバイダーから支給されます。
1. [サインインの状態を維持しますか?] ダイアログボックスで、[今後このメッセージを表示しない] チェックボックスを選択し、**[いいえ]** を選択します。
1. [いいえ] を選択して下部で表示されるパスワード保存のダイアログを閉じ、ご利用のブラウザー内で既存のグローバル管理者の認証情報が保存されないようにします。
1. Microsoft Azure へようこその画面で、[Cancel] を選択します。
1. **[リソースの作成]** を選択し、**Log Analytics ワークスペース**を検索します。
1. **Log Analytics ワークスペース タイル**を検索して、**[作成]** を選択します。
1. Log Analytics ワークスペースの作成サイトで、新しい**リソース グループ**を作成し、**`ContosoRG`** という名前を付けます。
1. [インスタンスの詳細] に名前 **`ContosoLA`** を入力し、リージョンに **[米国東部]** を選択します。
1. **[確認と作成]** を選択します
1. **[作成]** を選択してデプロイを開始します。

Log Analytics ワークスペースが正常に作成されました。

### タスク 2: Defender for Cloud を有効にする

Defender for Cloud でアセットに保護を適用する前に、セキュリティで保護するリソースの種類に対して Defender プランを有効にする必要があります。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. **Microsoft Defender for Cloud** を検索して開きます。
1. 左側のナビゲーション ウィンドウで、**[管理]** を展開し **[環境設定]** を選択します。
1. **[すべて展開]** を選択し、[サブスクリプション] を選択します。
1. サブスクリプションが**未登録**と表示されている場合は、ページを再読み込みしてください。
1. サブスクリプションの横にある省略記号 (...) を選択し、**[設定の編集]** を選択します。
1. **[クラウド ワークロード保護]** の下で、**サーバー** プランの右側のスライダーを **[オン]** に設定します。
1. ページの最上部で **[保存]** を選択します。

サーバーの計画を有効にすると、Defender for Cloud でさらに多くのリソースの種類がサポートされていることがわかります。

### タスク 3: Azure Arc でオンプレミス サーバーを有効にする

Defender for Cloud が使用する Log Analytics ワークスペースにデータを送信するために使用できるようにするには、Azure Arc が必要です。

1. VM **LON-SC2** にスワップし Azure portal **`https://portal.azure.com`** にサインインします。
1. **`Azure Arc`** を検索して開きます。
1. 左側のナビゲーション ウィンドウの **[Azure Arc リソース]** を展開して **[マシン]** を選択します。
1. **[追加/作成]** > **[マシンの追加]** を選択します。
1. [単一サーバーの追加] で **[スクリプトの生成]** を選択します。
1. [リソース グループ] フィールドで、ドロップダウン メニューを使用して **[ContosoRG]** を選択します。
1. [リージョン] フィールドで、ドロップダウン メニューを使用して **[米国東部]** を選択します。
1. **[スクリプトのダウンロードと実行]** を選択します。
1. **[ダウンロード]** を選択し、2 つ目の Lab Client **LON-SC2** でスクリプトを実行して、オンプレミス サーバーを Azure にオンボードします。
1. 管理者として Windows PowerShell を実行します。 これを行うには、マウスの右キーを使用してウィンドウの右下隅にある Windows アイコンを選択し、**Windows PowerShell(Admin)** を選択します。
1. 実行ポリシーを "制限なし" に設定します。

    ```Powershell
    Set-ExecutionPolicy -ExecutionPolicy unrestricted
    ```

1. PowerShell ウィンドウで、[Y] を選択します
1. オンボード スクリプトを実行します。 これを行うには、[ファイル エクスプローラー] を選択します。 サーバー VM のローカル C ドライブ上のダウンロード フォルダーに移動します。 右マウス キーを使用してファイル **[OnboardingScript]** を選択し、****[PowerShell で実行]** を選択します。
1. 認証ポップアップが表示されたら、Azure portal で使用しているのと同じアカウントでログインします。
1. スクリプトが正常に完了するまで待機します。
1. LON-SC1 に戻り、Azure Arc を開きます。
1. **[マシン]** を選択し、ページの上部にある **[更新]** を選択し、サーバーが Azure Arc に正常にデプロイされたことを確認します。

テスト サーバーで Azure Arc が正常に有効になり、データが Log Analytics ワークスペースに流れ始める必要があります。 ダッシュボードに何かが表示されるまで、このプロセスには時間がかかる場合があります。

### タスク 4: Defender for Cloud にサーバーを追加し、ログを収集します。

オンプレミス サーバーからイベント ログを取得するデータ収集ルールをデプロイします。 ルールにより、監視エージェントがサーバーに自動的にデプロイされ、以前に作成された Log Analytics ワークスペースにログが転送されます。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. Defender for Cloud を開きます。
1. 左側のナビゲーション ウィンドウで、**[管理]** を展開し **[環境設定]** を選択します。
1. **すべて展開**を選択します。
1. 以前に作成した Log Analytics ワークスペース、**ContosoLA** が表示されます。  
1. **ContosoLA** 行項目の省略記号 (...) を選択し、**[設定の編集]** を選択します。
1. **サーバー** プランの右側のスライダーを **[オン]** に設定します。
1. ページの最上部で **[保存]** を選択します。
1. 上部の検索バーを使用して**データ収集ルール**を検索し、検索結果からそれを選択します。
1. **［作成］** を選択します
1. - 規則名: **`ContosoDCR`**
   - リソース グループ: **ContosoRG**
1. **[次へ: リソース]** を選択します。
1. **[リソースの追加]** を選択します。 リソース グループのスコープを展開します。 以前にオンボードされた Azure Arc マシンを確認し、**[適用]** を選択します。
1. **[次へ: 収集と配信]** を選択します。
1. **[データ ソースの追加]** を選択します。
1. データ ソースの種類として **[Windows イベント ログ]** を選択します。
1. **[収集するイベント ログとレベルを構成する:]** のすべてのオプションを選択します。
1. **[次へ: ターゲット]** を選択します。
1. **[宛先の追加]** を選択します。
   - 宛先の種類: **Azure Monitor ログ**
   - アカウントまたは名前空間: **ContosoLA**
1. **[データ ソースの追加]** を選択します。
1. **[確認と作成]** を選択します。
1. **［作成］** を選択します

リソースが Defender for Cloud で完全にオンボードされるまで、数時間かかる場合があります。 次の手順では、このリソースに対して Defender for Cloud によって生成される推奨事項を確認します。

### タスク 5: 規制コンプライアンス標準の追加

推奨事項に基づいて、リソースのセキュリティ保護を開始し、セキュリティ ポリシー (NIST SP 800-53 Rev.5 など) を割り当てて、Tailwind Traders のリソースがコンプライアンス規制に準拠していることを確認できます。

1. 引き続き Azure portal **https://portal.azure.com** にログインする必要があります。
1. Defender for Cloud を開き、**[管理]** を展開し、**[環境設定]** を選択します。
1. **すべて展開**を選択します。
1. サブスクリプションの横にある省略記号 (...) を選択し、**[設定の編集]** を選択します。
1. 左側のナビゲーション メニューで、**[セキュリティ ポリシー]** を選択します。 リストの読み込みには時間がかかる場合があります。
1. **`NIST SP 800-53 Rev. 5`** を検索します。 状態スライダーを **[オン]** に変更します。
1. Defender for Cloud に戻り、**[クラウド セキュリティ]** を展開し、**[規制コンプライアンス]** を選択します。

ラボ環境の制限により、リソースとコンプライアンスに関する推奨事項を確認できません。 デプロイされたリソースが Defender for Cloud に表示されるまでしばらく時間がかかります。

規制コンプライアンス ダッシュボードで、ダッシュボードに表示される失敗した評価を確認して、推奨事項の詳細を理解できるようになりました。

これらのコントロールに対してリソースを継続的に評価することで、Defender for Cloud は、特定のコンプライアンス認定の達成を妨げる可能性のある問題を特定します。 規制コンプライアンスの維持は、組織のデータを保護し、セキュリティで保護されたクラウド環境を確保するために重要です。
