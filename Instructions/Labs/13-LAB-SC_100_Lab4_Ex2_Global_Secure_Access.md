# Global Secure Access

監視サーバーを設定したら、Global Secure Access (GSA) を使用してファイル サーバーへのセキュリティで保護されたネットワークを確立する必要があります。 特に Tailwind Traders が会社の IT インフラストラクチャにローカル サーバーを導入する場合は、これらのファイル サーバーをセキュリティで保護されたクラウド ストレージに移行できるようになるまで、これらのマシンへのアクセスをセキュリティで保護する必要があります。 あなたは、従業員がサーバーにアクセスできるように Tailwind Traders の VPN インフラストラクチャを作り直すことにしました。 

セキュアなネットワークを確立するには、まず、コネクタを作成する前に、Azure アプリ プロキシを作成し、クライアントを Entra ID に登録します。 その後、アクセス ポリシーを構成し、GSA クライアントをインストールします。 最後に、GSA 接続をテストして、すべてが正常に動作していることを確認します。

## パート 1: ソリューションを設計する (必須)

このタスクでは、オンプレミス環境へのリモート アクセスをセキュリティで保護します。

### 設計アプローチ

最初の手順では、説明されているシナリオに基づいて要件を分析し、目的を理解し、要件を定義します。

提供されているユース ケースに基づいて、次の要件を概説できます。

- オンプレミス サーバーのセキュリティで保護されたリモート アクセスを有効にする
- 既存のインフラストラクチャとの統合
- Tailwind Traders の非推奨のインフラストラクチャを使用しない

Global Secure Access は Contoso Ltd. の既存のクラウド インフラストラクチャと統合され、従業員は Tailwind Traders ローカル インフラストラクチャ内のローカル サーバーに安全にリモート接続できます。 GSA を確認し、サービスへのリモート アクセスに関する他の戦略との違いを考慮します。

### 提案されるソリューション

|要件|解決策|行動計画|
|----|----|----|
|オンプレミス サーバーのセキュリティで保護されたリモート アクセスを有効にする| EntraID Global Secure Access | グローバル セキュア アクセスを有効にする  |
|既存のインフラストラクチャとの統合 | アプリケーション プロキシ | Contoso のファイルサーバーにアプリケーション プロキシをデプロイする |

## パート 2: ソリューションを実施する (オプション)

### タスク 1: Global Secure Access のアクティブ化

最初の手順は、テナントで Global Secure Access をアクティブ化します。

1. **LON-SC1** VM (クライアント エンドポイント) にローカル**管理者**としてログインします。パスワードは、ラボ ホスティング プロバイダーによって提供されます。
1. **Microsoft Edge** を開いて、アドレス バーを選び、**https://entra.microsoft.com** に移動して、Entra ポータルに **MOD 管理者**admin@WWLxZZZZZZ.onmicrosoft.comとしてログインします (ZZZZZZ は、ラボ ホスティング プロバイダーによって提供された固有のテナント ID)。 ユーザーのパスワードは、ラボ ホスティング プロバイダーから支給されます。
1. **[サインインの状態を維持しますか?]** ダイアログボックスで、**[今後このメッセージを表示しない]** チェックボックスを選択し、**[いいえ]** を選択します。
1. **[パスワードの保存]** ダイアログ ボックスで、**[今はしない]** を選択します。
1. 同様に、**[Microsoft Edge にサインインする]** ダイアログ ボックスが表示された場合は、**[今はやめておく]** ボタンを選択します。
1. 画面の右上に**多要素認証の管理**という情報ボックスが表示される場合は、**X** を選択して閉じます。
1. 左側のナビゲーション ウィンドウで **[Global Secure Access]** を展開し、**[Dashboard]** を選択します。
1. **テナント内の [Global Secure Access をアクティブ化する]** で、**[アクティブ化]** を選択します。

Global Secure Access が正常にアクティブ化されました。

### タスク 2: TLS を有効にしてプライベート ネットワーク コネクタをインストールする

プライベート ネットワーク コネクタは、オンプレミス環境の Windows Server にインストールされ、バックエンド リソースとアプリケーションにアクセスできる軽量エージェントであり、グローバル セキュア アクセス サービスへの接続を容易にするために使用されます。  プライベート ネットワーク コネクタをインストールする前に、コネクタをインストールする Windows Server で TLS 1.2 が有効になっている必要があります。

1. ローカル**管理者**アカウントを使用して、サーバー VM、**LON-SC2** にログインします。 パスワードは、ラボ ホスティング プロバイダーから支給されます。
1. VM にログインすると、サーバー マネージャーが開きます。  このウィンドウは最小化することができます。
1. サーバーにプライベート ネットワーク コネクタをインストールするには、TLS 1.2 が有効になっている必要があります。  これを実現する方法にはいくつかあります。 この演習では、レジストリ キーをファイルに設定するコマンドをコピーし、そのファイルを実行します。

    1. **Microsoft Edge** を開きます。
    1. ブラウザー タブで、URL **`https://learn.microsoft.com/en-us/entra/global-secure-access/how-to-configure-connectors`** 入力し、キーボードの Enter キーを押して製品ドキュメントを開きます。
    1. **[Transport Layer Security (TLS) の要件]** セクションまで下にスクロールし **[レジストリ キーの設定]** の下に一覧表示されているコード ボックスから **[コピー]** を選択します。
    1. VM 内からメモ帳を開きます。 タスク バーの検索フィールドに「**`Notepad`**」と入力し、**[メモ帳]** を選択してアプリケーションを開きます。
    1. **Ctrl + V** キーを使用してメモ帳にコードを貼り付けます。  貼り付けたコードでは何も変更しないでください。 コードの最初の行が必要です。
    1. メモ帳で **[ファイル]** を選んでから、**[名前をつけて保存]** を選択します。 
    1. **"ファイルの種類"** フィールドで、ドロップダウンから **[すべてのファイル]** を選択し、**"ファイル名"** フィールドに「**`EnableTLS.reg`**」と入力し、**[保存]** を選択します。  ファイルを .reg 拡張子で保存することが重要です。 ドキュメントの保存場所をメモし、メモ帳を閉じます。
    1. タスク バーから**エクスプローラー**を開き、ファイルを保存したフォルダー (既定値は [PC > ドキュメント) に移動します。
    1. ファイル名 **Enable-TLS** をダブルクリックして実行します。  レジストリ ファイルを変更しようとしているので、"**続行しますか?**" と表示されます。  **[はい]** に続いて **[OK]** を選択します。  
    1. レジストリを更新したので、サーバーを再起動する必要があります。 サーバー VM のタスク バーで、**Windows アイコン**、を選択し、 **[電源]**、**[再起動]**、**[続行]** の順に選択します。
    1. 再起動後に、ローカル**管理者** として、もう一度サーバー VM にログインします。
    1. サーバー マネージャーを最小化するか閉じます。
1. **Microsoft Edge** を開いて、アドレス バーを選び、**`https://entra.microsoft.com`** に移動して、Entra ポータルに **MOD 管理者**admin@WWLxZZZZZZ.onmicrosoft.com としてログインします (ZZZZZZ は、ラボ ホスティング プロバイダーから提供された一意のテナント ID)。 ユーザーのパスワードは、ラボ ホスティング プロバイダーから支給されます。
1. 前のタスクと同様に、ダイアログ ボックスを閉じます。
1. 左側のナビゲーション パネルで、**[グローバル セキュア アクセス**、**[接続]** の順に展開して、**[コネクタ]** を選択します。
1. [プライベート ネットワーク コネクタ] ページの上部で **[ダウンロード コネクタ サービス]** を選択します。
1. 情報を確認し、**[規約に同意してダウンロード]** を選択します。
1. ダウンロードが完了したら、ページの右上隅にあるダウンロード ウィンドウで **[ファイルを開く]** を選択します。  [ファイルを開く] を選択できるようになる前にダウンロード ウィンドウが閉じた場合は、タスク バーから **[エクスプローラー]** を選択し、**ダウンロード** フォルダーに移動して、ファイル **MicrosoftEntraPrivateNetworkConnectorInstaller** を実行します。
1. **[同意する]** の隣にあるボックスを選択したあと、**[インストール]** を選択します。
1. インストール中に、MOD 管理者のユーザー名とパスワードでサインインする必要があります。 インストールを完了するのに数分かかることがあります。
1. インストールが完了したら、インストール ウィンドウを**閉じて**、ブラウザー ページを更新します。  コネクタが一覧に表示され、アクティブになっています。
1. たとえば、Windows タスク バーの検索バーに「**`cmd`**」と入力してから **[コマンド プロンプト]** を選択します。 
1. [管理者: コマンド プロンプト] ウィンドウで、**`ipconfig`** コマンドを実行し、サーバーのプライベート IP アドレスを書き留めてから、[コマンド プロンプト] ウィンドウを閉じます。

オンプレミス サーバーにプライベート ネットワーク コネクタが正常にインストールされました。

### タスク 3: ファイル サーバーにフォルダーを作成する

このタスクでは、GSA を介してアクセスされるオンプレミス ファイル サーバーに SMB 共有を作成します。

1. 引き続き LON-SC2 にログインしている必要があります。
1. タスク バーから**エクスプローラー**を開き、C: ドライブに移動して、**Share** という名前のフォルダーを作成します。
1. マウスの右キーを使用して、**Share** フォルダーを選択し、**[プロパティ]** を選択します。
1. [共有のプロパティ] ウィンドウで、**[共有]** タブを選択します。
1. **[共有...]** を選択します。
1. ドロップダウンから **[すべてのユーザー]** を選択し、**[追加]** を選択します。
1. **[共有]** を選択します。
1. **[いいえ、接続しているネットワークをプライベート ネットワークにします]** を選択します。
1. **[完了]** に続いて **[閉じる]** を選択します。
1. エクスプローラーを最小化するか閉じます。

サーバー上に共有フォルダーを作成しました。 GSA を介してアクセスするのは、このフォルダーとその内容です。

### タスク 4: クイック アクセスのセットアップとユーザーの割り当て

プライベート アクセスには、サービスをトンネリングするプライベート リソースを構成する 2 つの方法が用意されています。 クイック アクセスまたはグローバル セキュア アクセス アプリケーション この演習では、クイック アクセスを使用します。

クイック アクセスは、セキュリティで保護する FQDN と IP アドレスのプライマリ グループです。 クイック アクセスを構成するときに、セキュリティで保護するプライベート リソースのコンテナーとして機能する新しいエンタープライズ アプリケーションを作成します。

ユーザーが GSA クライアントを介してファイル サーバーのリソースにアクセスするには、クイック アクセスを有効にして、それをテスト ユーザーに割り当てる必要があります。

1. この手順は LON-SC2 のままで構いません。
1. 左側のナビゲーション ウィンドウで **[グローバル セキュア アクセス]** を展開し、**[アプリケーション]** を展開してから、**[クイック アクセス]** を選択します。 次の情報を入力してください。
    - 名前: **`SMB to ContosoFS`**
    - コネクタ グループ: **既定値**
1. **[クイック アクセス アプリケーション セグメントの追加]** を選択し、次の情報を入力します:
    - 宛先の種類: **IP アドレス**
    - IP アドレス: 前の手順でメモしたサーバーのプライベート IP アドレス、**`192.168.2.100`**。
    - ポート: **`445`**
1. **適用**を選択します。
1. **[保存]** を選択します。 アプリケーション セグメントの状態フィールドに成功が表示されたら、ブラウザー ページを更新します。 ページを更新すると、**[クイック アクセス | ネットワーク アクセスのプロパティ]** ページに移動します。
1. 左側で **[ユーザーとグループ]** を選択します。
1. **[Add user/group](ユーザーまたはグループの追加)** を選択します。
1. **[何も選択されていません]** を選択します。
1. 検索フィールドに **`MOD Administrator`** と入力してから、それを検索結果から選択します。
1. ページの下部で、**[選択]** を押してから、**[割り当て]** を選択します。

テスト ユーザーのクイック アクセスが正常に有効になりました。

### タスク 5: Entra ID へのデバイスの追加　

グローバル セキュア アクセスを使用するには、クライアント エンドポイントである LON-SC1 VM を Microsoft Entra ID に追加する必要があります。 そうしないと、GSA クライアントは機能しません。

1. **LON-SC1** VM に戻ります (これはクライアント エンドポイント VM です)
1. マウスの右キーを使用して、タスク バーの Windows アイコンを選択し、**[設定]** を選択します。
1. 左側のナビゲーション パネルで、**[アカウント]** を選択します。
1. アカウント ページから、**[職場または学校にアクセスする]** を選択します。
1. 職場または学校アカウントを追加するには、**[接続]** を選択します。
1. ウィンドウの下部から、**[デバイスを Microsoft Entra ID に追加]** を選択します。
1. ラボ プロバイダーによって提供される **MOD 管理者**の管理資格情報を使用してサインインします。
1. **[これがあなたの組織であることを確認します]** ウィンドウで、情報を確認してから、**[追加]** を選択します。
1. **[すべて設定済み]** ウィンドウの情報を確認し、**[完了]** を選択します。
1. デバイスが Entra ID に追加済みの MOD 管理者アカウントになったので、そのアカウントを使用してログインする必要があります。
    1. タスク バーから、**Windows** アイコンを選択し、**[管理]** を選択してから、**[ユーザーの切り替え]** を選択します。
    1. ウィンドウの左下で、**[その他のユーザー]** を選択してから、MOD 管理者アカウントでログインします。
    1. アカウントの設定には数分かかります。その後、**[必要な追加情報]** ウィンドウが表示されます。 これにより、多要素認証をセットアップするプロセスが開始されます。  MFA をセットアップする手順に従います。

エンドポイントが Entra ID に追加されると、グローバル セキュア アクセスで保護しているリソースへの接続に使用される GSA クライアントを設定することができます。

### タスク 6: トラフィック転送プロファイルのアクティブ化と GSA デスクトップ クライアントのダウンロード

オンプレミス環境のプライベート リソースまたはアプリケーションへのアクセスを有効にするには、プライベート アクセスのトラフィック転送プロファイルを有効にして、ユーザーを割り当てる必要があります。

また、グローバル セキュア アクセス デスクトップ クライアントをダウンロードしてインストールする必要もあります。  

プライベート アクセス トラフィックは、グローバル セキュア アクセス デスクトップ クライアント経由で接続することで、サービスに転送できます。

1. MOD 管理者アカウントでサインインした **LON-SC1** に引き続きログインしている必要があります。
1. **Microsoft Edge** を開きます。 Microsoft Edge をセットアップするように求められます。
1. Microsoft Edge から、**`https://entra.microsoft.com`** に移動します。
1. 左側のナビゲーション パネルで、**[グローバル セキュア アクセス]** を展開し、**[接続]** を展開し、**[トラフィック転送]** を選択します。  オプションを表示するには、**>>** を選択して左側のナビゲーション パネルを展開する必要がある場合があります。
1. **プライベート アクセス プロファイル**の横にあるスライダー ボタンを選択してから **[OK]** を選択します。
1. プライベート アクセス プロファイルを有効にしたので、ユーザーを割り当てる必要があります。
    1. プライベート アクセス プロファイル カードの **[ユーザーとグループの割り当て]** から、**[表示]** を選択します。
    1. **[ユーザーとグループが割り当てられていません]** と表示されている場所を選択します
    1. **[Add user/group](ユーザーまたはグループの追加)** を選択します。
    1. **[何も選択されていません]** を選択します。
    1. 検索バーに「**`MOD Administrator`**」と入力し、**[MOD 管理者]** を選択し、**[選択]** を押してから **[割り当て]** を選択します。
1. 左側のナビゲーション ウィンドウの **[接続]** で **[クライアント ダウンロード]** を選択します。
1. Windows 10/11 で、**[クライアントのダウンロード]** を選択します。
1. [ダウンロード] ウィンドウで、**[ファイルを開く]** を選択します。 [ファイルを開く] を選択できるようになる前にダウンロード ウィンドウが閉じた場合は、タスク バーから **[エクスプローラー]** を選択し、**ダウンロード** フォルダーに移動して、ファイル **GlobalSecureAccessClient** を実行します。
1. **[ライセンスの使用条件に同意する]** を選択してから、**[インストール]** を選択します。 ポップアップ表示される [ユーザー アカウント制御] ウィンドウで、**[はい]** を選択します。
1. インストールが正常に完了したら、ウィンドウを**閉じます**。
1. タスク バーから、上矢印を選択して非表示のアイコンを表示します。  ここには、グローバル セキュア アクセス クライアント アイコンが表示されます。 緑色のチェックマークがない場合は、アイコンを右クリックして **[有効にする]** を選択します。 接続されていることを示す緑色のチェックマークが付いた状態が表示されるには数分かかる場合があります。
1. タスク バーから **[エクスプローラー]** を選択して、**[この PC]** に移動します。 省略記号 (**...**) を選択し、**[ネットワーク ドライブを表示する]** を選択します。
1. [フォルダ―] フィールドに「`\\192.168.2.100\Share`」と入力します。 前にメモした IP アドレスを使用し、**[別の資格情報を使用して接続する]** を選択します。
1. **[完了]** を選びます。
1. ネットワーク ドライブを表示するには、LON-SC2 のローカルの管理者アカウントの資格情報を使用します。  
    1. メール フィールド: **`Administrator`** (これはラボのホストによって異なる場合があります)。
    1. パスワード フィールド: **`Pa55w.rd`** (これはラボのホストによって異なる場合があります)。
    
    >[!NOTE] ローカルの管理者アカウントの使用は一般的なシナリオではないことが確認されています。 この演習では、オンプレミス環境が簡略化されているために使用されます。 より複雑なオンプレミス環境という現実的なシナリオでは、ユーザーは Entra ID アカウントを使用してプライベート リソースにアクセスできます。

1. 次のラボに移行する前に、最適な画面サイズにするためにユーザーを切り替えておくことをお勧めします。
    1. タスク バーから、**Windows** アイコンを選択し、**[MOD 管理者]** を選択してから、**[ユーザーの切り替え]** を選択します。
    1. ウィンドウの左下で、**[管理]** を選択してから、ローカルの管理者アカウントでログインします。

グローバル セキュア アクセスを使用して、ファイル サーバーに正常に接続されました。
