# ラボ 2 - 演習 3 - テナント間同期

Contoso では最近 Tailwind Traders を買収しましたが、どのゲストが顧客またはパートナーで、どのゲストが買収した会社の従業員なのかを判断することが困難でした。 あなたのタスクは、Tailwind Traders から Contoso への初期の一般アドレスのリストを提供することです。 さらに、テナントでは、既知のドメイン名のみをゲスト ユーザーとして Entra ID に追加できるようにする必要があります。 組織にゲストを招待できるユーザーを内部ユーザーのみに制限する必要があります。 外部アクセスは 1 つのドメインのみに制限します。 また、Tailwind Traders から Contoso への B2B コラボレーションとテナント間同期も作成します。

サイバーセキュリティ アーキテクトは、すべての要件が満たされていることを確認し、必要な変更を Entra ID に実装してゼロ トラスト原則を適用する必要があります。 この演習では、ラボ パートナーと協力して、テナント間同期を作成します。 

## パート 1: ソリューションを設計する (必須)

このタスクでは、Contoso Ltd. と Tailwind Traders が直面している要件に対処するための概念を設計します。

### 設計アプローチ

最初の手順では、説明されているシナリオに基づいて要件を分析し、目的を理解し、要件を定義します。

提供されているユース ケースに基づいて、次の要件を概説できます。

- 両社のユーザーを同期する
- 外部ユーザーを外部ユーザーとして識別できるようにする
- 招待権限を内部の従業員のみに制限する 
- 外部アクセスを会社の信頼されたドメインに限定する

2 番目の手順では、Contoso Ltd. の既存の環境を調べます。 Microsoft Entra ID には、外部コラボレーションを可能にするソリューションが用意されています。 どのコントロールが存在し、どのポリシーが既に実施されているかを調査します。 Entra ID ポータルを使用して、現在の構成とポリシーを確認し、リージョンの要件を満たすために実装する必要がある調整を決定します。

3 番目のフェーズでは、ソリューションの概念を作成します。 調査の結果、テナント間同期が、すべての要件を満たすコラボレーションを有効にする最善の方法であることが明らかになります。  

### 提案されるソリューション

|要件|解決策|行動計画|
|----|----|----|
|招待権限を内部の従業員のみに制限する|外部コラボレーションの設定|招待権限をテナントのメンバーと特定の管理者招待ロールに制限する|
|信頼されたドメインの一覧を除くすべてのドメインからの招待をブロックする|外部コラボレーションの設定|信頼されたドメインのみを含む招待ホワイトリストを作成する|
|両社のユーザーを同期する|Entra ID テナント間同期|両方の Entra ID テナント間のアクセス信頼を確立し、ユーザーを他のテナントと同期する構成を作成する|
|外部ユーザーを外部ユーザーとして識別できるようにする|テナント間属性マッピング|テナント間同期構成の属性マッピング関数を使用してカスタム式を作成することで、同期されたすべてのユーザーの displayName 属性を編集します|

## パート 2: ソリューションを実施する (オプション)

### タスク 1 - チームを組み準備する

このタスクでは、テナント間同期の前提条件を確認し、ラボ パートナーとチームを組みます。

1. Client 1 VM (LON-Sc1) に **lon-cl1\admin** アカウントでログインします。 パスワードは、ラボ ホスティング プロバイダーから支給されます。
2. **Microsoft Edge** を開いて、アドレス バーを選び、**https://entra.microsoft.com** に移動して、Entra ポータルに **MOD 管理者**admin@WWLxZZZZZZ.onmicrosoft.com としてログインします (ZZZZZZ は、ラボ ホスティング プロバイダーから提供された一意のテナント ID)。 管理者のパスワードは、ラボ ホスティング プロバイダーから支給されます。
3. **[サインインの状態を維持しますか?]** ダイアログボックスで、**[今後このメッセージを表示しない]** チェックボックスを選択し、**[いいえ]** を選択します。
4. [いいえ] を選択して下部で表示されるパスワード保存のダイアログを閉じ、ご利用のブラウザー内で既存のグローバル管理者の認証情報が保存されないようにします。
5. 左側のナビゲーション ウィンドウで、**[ID]**、**[概要]** の順に移動します。
6. **[概要]** タブに表示される **[テナント ID]** と **[プライマリ ドメイン]** を書き留めます。
7. **[テナント ID]** と **[プライマリ ドメイン]** をラボ パートナーと交換します。

使用するトポロジ、最初の同期テストの対象となるユーザー、および Contoso の Entra ID テナントにマップする方法を計画する必要があります。

### タスク 2 - テナント間アクセスを構成する

テナント間同期の実装に必要な情報を準備したので、テナントがパートナーのテナントにアクセスするために必要な手順を実行します。その逆も同様です。

1. 引き続き Entra ID ポータル **https://entra.microsoft.com** にログインする必要があります。
2. 左側のナビゲーション バーで、**[ID]** > **[External Identities]** > **[テナント間アクセス設定]** に移動します。
3. ** [組織の設定]** タブを選択して、**[組織の追加]** を選択します。
4. **"テナント ID またはドメイン名"** フィールドにラボ パートナーから提供されたテナント ID を入力し、**[追加]** を選択します。
5. Contoso の **[インバウンド アクセス]** で、**[既定値から継承]** を選択して、その特定のテナントのテナント間同期設定にアクセスします。
6. **[信頼の設定]** で、**[テナント Contoso で招待を自動的に引き換え]** を有効にします。
7. **[保存]** を選択します。
8. **[テナント間同期]** で、**[ユーザーにこのテナントへの同期を許可する]** を有効にします。
9. **[保存]** を選択し、右上隅にある **[X]** を使用してダイアログから閉じます。
10. Contoso の **[アウトバウンド アクセス]** で、**[既定値から継承]** を選択して、その特定のテナントのテナント間同期設定にアクセスします。
11. **[信頼の設定]** で、**[テナント Contoso で招待を自動的に引き換え]** を有効にします。
12.  **[保存]** を選択し、右上隅にある **[X]** を使用してダイアログから閉じます。

ユーザーが招待を手動で引き換える必要なく、テナントがパートナーのテナントと両方の方法で同期できるようにしました。 

### タスク 3 - 外部アクセスを制限する

このタスクでは、招待を送信するアクセス許可を持つユーザーの範囲を制御することで、新しいゲスト ユーザーを組織に招待する機能を制限します。 ゲストとしてパートナーのテナント ドメインに招待できるドメインのスコープを制限します。

1. 引き続き Entra ID ポータル **https://entra.microsoft.com** にログインする必要があります。
2. 左側のナビゲーション ウィンドウで、**[ID]**、**[External Identities]**、**[外部コラボレーションの設定]** の順に移動します。
3. **[ゲスト招待の設定]** セクションで、**[メンバー アクセス許可を持つゲストを含むメンバー ユーザーと特定の管理者ロールに割り当てられたユーザーがゲスト ユーザーを招待できる]** を選択します。
4. **[コラボレーションの制限]** で **[指定したドメインに対してのみ招待を許可します]** を選択します。
5. パートナーのドメイン **WWLxZZZZZZ.onmicrosoft.com** を追加します (ZZZZZZ は、ラボ ホスティング プロバイダーから提供されたパートナーの一意のテナント ID)。
6. **[保存]** を選択します。

これで、招待元として招待できるユーザーと、テナントへの招待対象にできるユーザーが制限されました。 

### タスク 4: 構成を作成する

このタスクでは、基本的な構成を作成し、他のテナントへの接続をテストします。

1. 引き続き Entra ID ポータル **https://entra.microsoft.com** にログインする必要があります。
2. 左側のナビゲーション ウィンドウで、**[ID]**、**[External Identities]**、**[テナント間同期]**、**[構成]** の順に移動します。
3. **新しい構成**を作成します。
4. 「**Contoso cross-tenant synchronization**」と名前を入力し、**[作成]** を選択します。
5. **[プロビジョニング]** で、**[プロビジョニング モード]** を [自動] に変更します。
6. **[テナント ID]** ボックスに、タスク 1 でメモしたパートナーのテナント ID を入力します。
7. **[接続テスト]** を選択します。
8. **[保存]** を選択します。

アクセス設定が正しく構成された場合、提供された資格情報でプロビジョニングを有効にすることが承認されたことを示すメッセージが表示されるはずです。 テスト接続が失敗した場合は、パートナーがタスク 3 で正しいドメインに入り、タスク 2 の説明のとおりにテナント間同期を構成したかどうかを確認します。

### タスク 5: ユーザー スコープを定義する

このタスクでは、最初の同期の対象となるユーザーを定義します。 

1. 今作成した構成のプロビジョニング設定で、Entra ID ポータル (**https://entra.microsoft.com**) にログインしたままである必要があります。 そうでない場合は、次の 3 つの手順に従って元の状態にしてください。
   1. 左側のナビゲーション ウィンドウで、**[ID]**、**[External Identities]**、**[テナント間同期]**、**[構成]** の順に移動します。
   2. **[Contoso cross-tenant synchronization]** を選択します。
   3. **[プロビジョニング]** に移動します。
2. **[設定]** セクションを展開します。
3. [範囲] ドロップダウンが **[割り当てられたユーザーとグループのみを同期する]** に設定されていることを確認します。
4. この設定を変更する場合は、**[保存]** を選択します。
5. ナビゲーション ウィンドウで、**[ユーザーとグループ]** を選択します。
6. **[Add user/group](ユーザーまたはグループの追加)** を選択します。
7. **[割り当ての追加]** ページで、**[何も選択されていません]** を選択します。
8. **[法務]** を検索し、チェック ボックスを使用して **[法務チーム]** を強調表示してから、**[選択]** を選択します。
9. **[割り当て]** を選択して、2 人のユーザーで構成されるチームを同期スコープに追加します。

これで、パートナーのテナントへの同期に対するユーザーの最初のスコープが定義されました。

### タスク 6 - 属性マッピングを確認する

このタスクでは、属性マッピングを確認し、同期されたユーザーが Contoso のグローバル アドレス一覧に表示されるようにします。

1. テナント間同期構成の**ユーザーとグループ**設定の Entra ID ポータル **https://entra.microsoft.com** に引き続きログインしている必要があります。 ログインしていない場合は、次の 2 つの手順に従って構成ページに戻ります:
   1. 左側のナビゲーション ウィンドウで、**[ID]** > **[External Identities]** > **[テナント間同期]** > **[構成]** に移動します。
   2. **[Contoso テナント間同期]** を選択します。
2. **[プロビジョニング]** に移動し、**[マッピング]** セクションを展開します。
3. **[Microsoft Entra ID ユーザーのプロビジョニング]** を選択します。
4. **[showInAddressList]** 属性で、[編集] を選択します。
5. マッピングの種類が**定数**に設定され、その値が **true** に設定されていることを確認します。
6. **OK** を選択します。
7. **[displayName]** 属性で、**[編集]** を選択します。
8. [マッピングの種類] を **[式]** に変更します
9. 既存の式を削除します。
10. **[式ビルダーを使用する]** を選択します。
11. 関数の **[追加]** を選択します。
12. **[displayName]** 属性を選択します。
13. **' (Contoso)'** を入力します。ブラケットの前にスペースを含めますが、引用符は含めません。
14. **[式の追加]** を選択します。
    -  右の式は `Append([displayName], " (Contoso)")` のようになります
15. ユーザーを選択して式をテストできます。
16. **[式の適用]** を選択し、**[OK]** を選択して編集ダイアログを離れます。
17. **[保存]** を選択します。
18. 右上隅にある **[X]** を選択して、[属性マッピング] ページを閉じます。

これで、同期されたすべてのユーザーが他のテナントのグローバル アドレス一覧に表示されるようになります。 また、他のテナント内のすべての同期されたユーザーの表示名に (Contoso) 式を追加しました。

### タスク 7 - ラボ パートナーとのプロビジョニングとテストを有効にする

このタスクでは、プロビジョニングを有効にし、必要な方法でユーザーが他のテナントに表示されるかどうかをテストします。 自動プロビジョニングには時間がかかる場合があるため、手動プロビジョニングをトリガーします。

1. テナント間同期構成のプロビジョニング設定の Entra ID ポータル **https://entra.microsoft.com** に引き続きログインしている必要があります。 ログインしていない場合は、次の 2 つの手順に従って構成ページに戻ります:
   1. 左側のナビゲーション ウィンドウで、**[ID]** > **[External Identities]** > **[テナント間同期]** > **[構成]** に移動します。
   2. **[Contoso テナント間同期]** を選択する
2. **[オンデマンドでプロビジョニング]** に移動します。
3. スコープ付き**法務チーム**のメンバーとして **Grady Archie** を検索します。
4. **[プロビジョニング]** を選びます。
    - プロビジョニングが完了すると、確認が表示されます。
5. 右上隅の **[X]** を選択して、[アクションの実行] ページを閉じます。

最初のユーザーを手動でプロビジョニングしたばかりで、パートナー テナントのユーザーリストを確認すると、ユーザーの Grady Archie (Contoso) が表示されます。

### タスク 8 - 完全同期のロールアウト

最初のユーザー プロビジョニングが正常にテストされたので、ユーザー リストの残りを他のテナントにプロビジョニングします。

1. テナント間同期構成の **[オンデマンドでプロビジョニング]** ページの Entra ID ポータル **https://entra.microsoft.com** に引き続きログインしている必要があります。 ログインしていない場合は、次の 2 つの手順に従って構成ページに戻ります:
   1. 左側のナビゲーション ウィンドウで、**[ID]** > **[External Identities]** > **[テナント間同期]** > **[構成]** に移動します。
   2. **[Contoso cross-tenant synchronization]** を選択します。
2. ユーザーおよびグループの選択
3. **[Add user/group](ユーザーまたはグループの追加)** を選択します。
4. **[割り当ての追加]** ページで、**[何も選択されていません]** を選択します。
5. **すべての従業員**グループを選択します。これは **Contoso のすべての従業員**を含むグループであるからです。
6. 選択内容を確認します。
7. **割り当て**を選びます。

これで、テナントと別のテナント間のテナント間同期が正常に作成されました。 デモ テナントで行ったすべての作業を Tailwind Traders の生産的なシステムに適応させ、Contoso に統合できるようにする必要があります。
