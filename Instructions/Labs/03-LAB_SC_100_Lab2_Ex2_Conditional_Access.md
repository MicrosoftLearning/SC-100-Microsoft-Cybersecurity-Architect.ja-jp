# 条件付きアクセス

条件付きアクセス ポリシーで特定の場所とデバイスからのアクセスのみが許可されているにもかかわらず、従業員が不明な場所から Microsoft 365 にアクセスしていることを確認しました。 調査の結果、これらの従業員が公共交通機関でオフィスから家に帰る間に Microsoft 365 にアクセスすることが明らかになっています。 この行為は業界の規制に違反しているため、継続的アクセス評価を使用して防止する必要があります。 さらに、前の演習で準備した認証強度を実装して、顧客データを処理する特定のアプリケーションをセキュリティで保護する必要があります。 

## パート 1: ソリューションを設計する (必須)

このタスクでは、Contoso Ltd. が直面しているリスクに対処するための概念を設計します。

### 設計アプローチ

最初の手順では、説明されている問題に基づいて要件を分析し、目的を理解し、要件を定義します。

提供されているユース ケースに基づいて、次の要件を概説できます。

- 安全でない場所または不明な場所からのアクセスを制限する
- 機密情報を含むアプリに強力な認証を要求する

2 番目の手順では、Contoso Ltd. の既存の環境を調べます。 Microsoft Entra ID には、Entra ID 条件付きアクセス ポリシーを使用してユーザー アクセスを管理および制限するソリューションが用意されています。 どのコントロールが存在し、どのポリシーが既に実施されているかを調査します。 Entra ID ポータルを使用して、現在の構成とポリシーを確認し、調整が必要かどうか、または新しいポリシーを実装する必要があるかどうかを判断します。

3 番目のフェーズでは、ソリューションの概念を作成します。 調査の結果、信頼されたネットワークがまだ構成されておらず、定義された要件を満たす現在のポリシーがないことは明らかです。 そのため、新しい条件付きアクセス ポリシーのセットが不可欠です。 

### 提案されるソリューション

|要件|解決策|行動計画|
|----|----|----|
|安全でない場所または不明な場所からのアクセスを制限する|Entra ID 条件付きアクセス ポリシー|現在の会社のネットワークを信頼できるネットワークとして定義し、このネットワーク内のデバイスへのアクセスを制限する|
|機密情報を含むアプリに強力な認証を要求する|Entra ID 条件付きアクセス ポリシー|SMS や音声などの安全でない認証方法を除外し、作成したばかりの強化された認証強度を必要とする機密アプリケーションを対象とした新しい条件付きアクセス ポリシーを作成する|

## パート 2: ソリューションを実施する (オプション)

### タスク 1 - 信頼できるネットワークを作成する

このタスクでは、VM の外部 IP アドレスを使用してネームド ロケーションを作成し、次のタスクの条件付きアクセス ポリシーで使用できる信頼されたネットワークを定義します。 マシンが会社のネットワーク内にあるため、このアドレスを使用します。

1. Client 1 VM (LON-Sc1) に **lon-cl1\admin** アカウントでログインします。 パスワードは、ラボ ホスティング プロバイダーから支給されます。
1. マウスの右ボタンでスタート メニューを選択して **PowerShell** ウィンドウを開き、**ターミナル**を選択します。
1. 次のコマンドレットを入力して、現在の外部 IP アドレスを確認します。
    ```powershell
    curl ifconfig.me | Select-String -Pattern '.'
    ```
1. 返された IP アドレス PowerShell をメモします。
1. **Microsoft Edge** を開いて、アドレス バーを選び、**`https://entra.microsoft.com`** に移動して、Entra ID ポータルに **MOD 管理者**admin@WWLxZZZZZZ.onmicrosoft.com としてログインします (ZZZZZZ は、ラボ ホスティング プロバイダーによって提供された固有のテナント ID)。 管理者のパスワードは、ラボ ホスティング プロバイダーから支給されます。
1. 多要素認証の設定を求められた場合は、手順に従います。
1. [サインインの状態を維持しますか?] ダイアログボックスで、**[今後このメッセージを表示しない]** チェックボックスを選択し、**[いいえ]** を選択します。
1. **[今はしない]** を選択してパスワード保存のダイアログ ボックスを閉じ、ご利用のブラウザー内で既定のグローバル管理者の認証情報が保存されないようにします。
1. 左側のナビゲーション ウィンドウで、**[保護]** > **[条件付きアクセス]** > **[ネームド ロケーション]** に移動します。
1. **[+ IP 範囲の場所]** を選択します。
1. 「**Trusted contoso network**」という名前を入力します。
1. **[信頼できる場所としてマークする]** を選択します。
1. **[+]** を選択して、**手順 4** でメモした IP アドレス追加します。
1. 入力は ``168.245.***.***/32`` のようになります (*** の部分は、ラボ ホスティング プロバイダーによって異なる場合があります)。
1. **[追加]** を選択します。
1. **［作成］** を選択します

これで、会社のネットワーク外からのアクセスを制限するのに使用できる、会社の外部 IP アドレスの名前と信頼できる場所を定義しました。

### タスク 2 - 範囲が制限された新しい条件付きアクセス ポリシーを作成する

信頼されたネットワークが正常に作成されたので、これを使用して条件付きアクセス ポリシーを作成し、範囲が個人ユーザーに限定された企業ネットワークの外部からのアクセスを制限して、Entra ID からの全社的なアカウント ロックアウトをテストし防止できるようにします。

1. 引き続き Entra ID ポータル **https://entra.microsoft.com** にログインする必要があります。
2. 左側のナビゲーション ウィンドウで、**[保護]**、**[条件付きアクセス]**、**[ポリシー]** の順に移動します。
3. **[新しいポリシー]** を選択します。
4. 「**信頼されたネットワークの外部からのアクセスをブロックする**」という名前を入力します。
5. **[0 人のユーザーとグループが選択されました]** を選択します。
6. **[対象]** で **[ユーザーとグループの選択]** を選択し、**[ユーザーとグループ]** をオンにします。
7. ポリシーの唯一のテスト ユーザーとして **Allan Deyoung** を選択します。
8. **[ターゲット リソースが選択されていません]** を選択し、**[対象]** で **[すべてのクラウド アプリ]** を選択します。
9. **[0 個の条件が選択されました]** を選択し、**[場所]** で **[未構成]** を選択します。
10. **[はい]** を選択して、場所の条件を構成します。
11. **[対象]** で **[すべての場所]** を選択します。
12. **[対象外]** で **[すべての信頼できる場所]** を選択します。
13. **[許可]** で **[0 個のコントロールが選択されました]** を選択し、**[アクセス権の付与]** から **[アクセスのブロック]** に切り替え、ページの下部にある **[選択]** を選択します。
14. **[セッション]** で、**[0 個のコントロールが選択されました]** を選択します。
15. **[継続的アクセス評価をカスタマイズする]** を有効にし、**[場所ポリシーを厳密に適用する (プレビュー)]** を選択して、下部にある **[選択]** を選択して確定します。
16. **[ポリシーの有効化]** のところで **[オン]** を選択して、**[作成]** を選択します。

これで、信頼されたネットワークの外部からのアクセスを制限する CA ポリシーを作成して有効にしました。これは、独自のテスト ユーザー アカウントにのみ影響を及ぼすものです。

### タスク 3 - 構成済みのポリシーをテストする

会社のすべてのクラウド アプリケーションへのアクセスを制限する条件付きアクセス ポリシーを作成したので、アクセスが引き続き可能であることを確認する必要があります。

>[!警告] このタスクは、説明のために大幅に省略されています。
実際のシナリオでは、予測不可能なインシデントが結果を歪めないように、より大規模で代表的なグループを使用して、より長い期間でテストを実行することになるでしょう。

1. **Microsoft Edge** ブラウザーで、マウスの右ボタンでタスク バー アイコンを選択してから **[新しい InPrivate ウィンドウ]** を選択することで、新しい **InPrivate** ウィンドウを開きます。
1. アドレス バーを選択し、**`https://portal.microsoft.com`** に移動して、M365 ポータルに **Allan Deyoung**alland@WWLxZZZZZZ.onmicrosoft.com としてログインします (ZZZZZZ はラボ ホスティング プロバイダーから提供された一意のテナント ID)。 ユーザーのパスワードは、ラボ ホスティング プロバイダーから提供されます。
1. [サインインの状態を維持しますか?] ダイアログボックスで、**[今後このメッセージを表示しない]** チェックボックスを選択し、**[いいえ]** を選択します。
1. ログインが成功したので、**InPrivate** ウィンドウを閉じることができます。
1. Edge ブラウザー ウィンドウに戻ります。Entra ID ポータル **https://entra.microsoft.com** にまだログインしているはずです。
1. 左側のナビゲーション ウィンドウで、**[保護]**、**[条件付きアクセス]**、**[監視]**、**[サインイン ログ]** の順に移動します。
1. **[フィルターの追加** を選択し、**Allan Deyoung** という **[ユーザー]** でフィルター処理します。
1. **Allan Deyoung** の最新のログ エントリを選択します。
1. **[条件付きアクセス]** タブで、**[信頼されたネットワークの外部からのアクセスをブロックする]** を選択します。
1. **[ユーザー]** 割り当てを選択すると、**[直接割り当て]** に **[一致]** することが表示されます。
1. **[アプリケーション]** 割り当てを選択すると、**[含まれるすべてのアプリ]** に **[一致]** することが表示されます。
1. また、**[場所]** 条件は、除外される信頼されたネットワーク内に含まれているので **[不一致]** になったことがわかります。
別の外部 IP アドレスを持つネットワークからログインしようとすると、この条件が一致し、ログイン試行がブロックされます。
1. **[条件付きアクセス ポリシーの詳細]** と **[アクティビティの詳細: サインイン]** を閉じます。

これで、会社のネットワーク内からすべてのクラウド アプリケーションへのアクセスが正常にテストされ、保証されるようになりました。 また、サインイン ログをチェックして、ポリシーが意図したとおりに動作し、正しい割り当てと条件を使用して、会社のネットワークの外部からクラウド アプリケーションへのアクセスを制限していることを確認しました。

### タスク 4 - 全社的なポリシーのロールアウト

前のタスクでテストに成功したので、会社全体でポリシーを有効にできるようになりました。 それには、既存のポリシーのユーザー スコープを編集します。

>[!警告] このタスクで実装したアクションは、アカウント ロックアウトを引き起こす可能性があります。
生産的な実際のシナリオでは、このポリシーから除外される緊急用管理者アカウントが少なくとも 1 つ必ず存在するようにします。 

1. 引き続き Entra ID ポータル **https://entra.microsoft.com** にログインする必要があります。
2. 左側のナビゲーション ウィンドウで、**[保護]**、**[条件付きアクセス]**、**[ポリシー]** の順に移動します。
3. **[信頼されたネットワークの外部アクセスをブロックする]** ポリシーを選択します。
4. [ユーザー] で、**[組み込まれた特定のユーザー] **を選択します。
5. **[すべてのユーザー]** を選択します。
6. ウィンドウの下部に表示された警告で、**[現在のユーザー admin@WWLxZZZZZZ.onmicrosoft.com をこのポリシーから除外する]** を選択します。
7. **[保存]** を選択します。

これで、会社の外部 IP アドレスとして定義した、信頼されたネットワークの外部にユーザーがログインできないようにするアクティブな作業条件付きアクセス ポリシーが構成されました。 これは、制限されたユーザー スコープを使用してテストされ、すべてのクラウド アプリケーションにアクセスできることを確認しました。 最後に、CA ポリシーをすべてのユーザーにロールアウトしました。

信頼されたネットワークの外部からのアクセスが正常に制限されました。

### タスク 5 - Salesforce に MFA を要求する

このタスクでは、Salesforce にサインインするときに、前の演習で作成した認証強度を適用する CA ポリシーを作成します。 

>[!IMPORTANT] 重要: このタスクは、テスト フェーズをスキップします。 実際のシナリオでは、前のタスクで見たように限られたユーザー スコープで最初にテストし、テスト フェーズが成功した後に完全なロールアウトを実行します。

1. 引き続き Entra ID ポータル **https://entra.microsoft.com** にログインする必要があります。
2. 左側のナビゲーション ウィンドウで、**[保護]**、**[条件付きアクセス]**、**[ポリシー]** の順に移動します。
3. **[新しいポリシー]** を選択します。
4. 名前 **Salesforce 認証強度**を入力します。
5. **[0 人のユーザーとグループが選択されました]** を選択します。
6. **[対象]** で **[ユーザーとグループの選択]** を選択し、**[ユーザーとグループ]** をオンにします。
7. ポリシーの唯一のテスト ユーザーとして営業から **Alex Wilber** を選択します。
8. **[ターゲット リソースが選択されていません]** を選択し、**[対象]** で、**[アプリの選択]** を選択します。
9. **[選択]** で、**[なし]** を選択し、**Salesforce** を検索します。
10. **[選択]** で、選択を確認します。
11. **[許可]** で **[0 個のコントロールが選択されました]** を選択し、**[認証強度の要求]** を有効にします。
12. カスタムで作成された認証強度 **[強化された MFA]** を選択し、**[選択]** ボタンで確認します。
13. 次に、下部にあるコントロール バーを使用してポリシーを **[On]** に設定し、**[作成]** を選択します。
14. 制限されたユーザー スコープでテスト フェーズが成功したら、**[Salesforce 認証強度]** を選択します。
15. [ユーザー] で、**[組み込まれた特定のユーザー] **を選択します。
16. **[すべてのユーザー]** を選択します。
17. **[保存]** を選択します。

これで、SMS OTP を除く Salesforce に認証強度ポリシーを適用し、SMS インターセプトを使用した攻撃の成功を防ぐための CA ポリシーが作成されました。
